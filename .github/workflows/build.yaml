name: Build and Push to Release Branch

on:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        default: true

    - name: Add targets
      run: |
        rustup target add x86_64-unknown-linux-gnu
        rustup target add aarch64-unknown-linux-gnu
        rustup target add x86_64-unknown-linux-musl
        rustup target add x86_64-pc-windows-msvc
        rustup target add aarch64-apple-darwin

    - name: Build
      run: |
        cargo build --release --target=x86_64-unknown-linux-gnu --bin ttrim
        cargo build --release --target=aarch64-unknown-linux-gnu --bin ttrim
        cargo build --release --target=x86_64-unknown-linux-musl --bin ttrim
        cargo build --release --target=x86_64-pc-windows-msvc --bin ttrim
        cargo build --release --target=aarch64-apple-darwin --bin ttrim

    - name: Prepare binaries
      run: |
        mkdir x86_64-unknown-linux-gnu
        mkdir aarch64-unknown-linux-gnu
        mkdir x86_64-unknown-linux-musl
        mkdir x86_64-pc-windows-msvc
        mkdir aarch64-apple-darwin

        mv target/x86_64-unknown-linux-gnu/release/ttrim x86_64-unknown-linux-gnu/
        mv target/aarch64-unknown-linux-gnu/release/ttrim aarch64-unknown-linux-gnu/
        mv target/x86_64-unknown-linux-musl/release/ttrim x86_64-unknown-linux-musl/
        mv target/x86_64-pc-windows-msvc/release/ttrim.exe x86_64-pc-windows-msvc/
        mv target/aarch64-apple-darwin/release/ttrim aarch64-apple-darwin/

    - name: Push to Release Branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b releases
        git add -A
        git commit -m "Add new release binaries"
        git push -u origin releases
